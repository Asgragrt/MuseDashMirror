<Project>
    <PropertyGroup>
        <ImplicitUsings>enable</ImplicitUsings>
        <LangVersion>latest</LangVersion>
        <GameFolder Condition="Exists('$(MD_DIRECTORY)')">$(MD_DIRECTORY)</GameFolder>
        <MelonLoader>$(GameFolder)\MelonLoader\</MelonLoader>
        <MelonNET6>$(MelonLoader)\net6\</MelonNET6>
        <MelonAssemblies>$(MelonLoader)\Il2CppAssemblies\</MelonAssemblies>
        <OutputPath>$(SolutionDir)\bin</OutputPath>
        <BeforePack>$(BeforePack);IncludePackAsAnalyzerProjectReferences</BeforePack>
    </PropertyGroup>

    <ItemDefinitionGroup>
        <Reference Private="false"/>
    </ItemDefinitionGroup>

    <Target Name="IncludePackAsAnalyzerProjectReferences"
            Condition="'@(ProjectReference)' != '' and @(ProjectReference->AnyHaveMetadataValue('PackAsAnalyzer', 'true'))">

        <MSBuild Projects="@(ProjectReference->WithMetadataValue('PackAsAnalyzer', 'true'))"
                 Targets="GetPackAsAnalyzerFiles">
            <Output TaskParameter="TargetOutputs" ItemName="PackAsAnalyzerFile"/>
        </MSBuild>

        <ItemGroup>
            <Content Include="@(PackAsAnalyzerFile->WithMetadataValue('IsSymbol', ''))"
                     Pack="True"/>
            <_TargetPathsToSymbols Include="@(PackAsAnalyzerFile->WithMetadataValue('IsSymbol', 'true'))"
                                   TargetPath="/%(PackAsAnalyzerFile.PackagePath)"/>
        </ItemGroup>
    </Target>

    <Target Name="GetPackAsAnalyzerFiles"
            DependsOnTargets="$(GenerateNuspecDependsOn)"
            Returns="@(PackAsAnalyzerFile)">

        <PropertyGroup>
            <PackAsAnalyzerPath>analyzers/dotnet</PackAsAnalyzerPath>
        </PropertyGroup>

        <ItemGroup>
            <PackAsAnalyzerFile Include="@(AnalyzerFiles)"/>
            <PackAsAnalyzerFile Include="@(_TargetPathsToSymbols)" IsSymbol="true"/>
            <PackAsAnalyzerFile PackagePath="$(PackAsAnalyzerPath)/%(TargetPath)"/>
        </ItemGroup>
    </Target>

</Project>